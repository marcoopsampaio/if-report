---
title: "Data sources and cleaning"
output:
  html_document:
    toc: true
    number_sections: true
    code_folding: show
---

Before we start we set up some things
```{r, message=FALSE, warning=FALSE}
library(xlsx)
rm(list=ls())# Cleaning up workspace before starting
setwd("/home/mops2/Work/projects/IF_report/git-hub-repo-if_report/")
```

This document describes the source data that was gathered from the FCT website regarding the portuguese investigator calls for the period 2013-2015. For further information see https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/estatisticas.phtml.pt

# Utilities
First I will design a few useful functions. I Want:

1. A master function that stats and creates a raw_data directory and a log file to keep information on when downloads were made and sub-directories and files were created.
```{r}
  # This function uses the working directory as reference
  make_data_directory <- function(directory_name){
    if(!file.exists(directory_name) & directory_name != "./" & directory_name != "." & directory_name != ""){
        dir.create(directory_name)
      write(paste("Directory ",as.character(directory_name)," was created at ",system("date -u", intern = TRUE)), file = dir_log, append = TRUE)
        close(dir_log)
    }
    else if(directory_name == "./" | directory_name == "." | directory_name == ""){
        stop("Please specify a valid directory to hold your data!")
    }
    else{
        warning(paste("The",directory_name,"directory and directory.log already exist."))
    }
    directory_name
  }
```
2. A function that stats for a sub-directory and creates it if necessary and writes and entry in the log.
```{r}
  make_data_sub_directory <- function(directory_name, sub_directory_name){
    # make master directory first if necessary
    make_data_directory(directory_name)
    # Then move on to make this sub-directory
    rel_path <-paste(directory_name,"/",sub_directory_name,sep="") 
    if(!file.exists(rel_path)){
      dir.create(rel_path)
      dir_log <- file(paste(directory_name,"/directory.log",sep=""),"a")
      write(paste("sub-directory",rel_path,"was created at ",system("date -u", intern = TRUE)), dir_log, append = TRUE)
      close(dir_log)
    }else{
      warning(paste("The",rel_path,"directory already exists."))
    }
    rel_path
  }
```
3. A function that stats for a downloaded file and downloads it if necessary and writes an entry in the log.
```{r}
  make_data_file_download <- function(directory_name, sub_directory_name,url_path,filename){
    # make master directory first if necessary
    make_data_directory(directory_name)
    # make sub directory if necessary
    make_data_sub_directory(directory_name, sub_directory_name)
    # Then download file
    rel_path <-paste(directory_name,"/",sub_directory_name,sep="") 
    rel_path_file <-paste(directory_name,"/",sub_directory_name,"/",filename,sep="") 
    if(!file.exists(rel_path_file)){
      file_log <- file(paste(rel_path_file,".log",sep=""),"w")
      download.file(url_path, destfile	= rel_path_file)
      write(paste("File",rel_path_file,"was downloaded at",system("date -u", intern = TRUE),"from the following url: ",url_path), file_log)
      close(file_log)
    }else{
      warning(paste("The",rel_path_file,"file already exists."))
    }
    rel_path_file
  }
```

# Raw data import and cleaning
We will keep all the raw data out of the repository at this relative location:
```{r, warning=FALSE}
  raw_dir <- "raw_data"
```

## IF competition 2013

The sub-directory name for the data for this year was chosen to be named
```{r, warning=FALSE}
  sub_dir2013 <- "2013"
```

### Ranked list before appeals

**DOWLOAD**

We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file1_url_2013 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2013/docs/FCTInvestigator2013-ResultsAfterEvaluationBeforeAppeal-locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file1_name_2013 <- "2013-file1-all_candidates_before_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  file1_rel_path_2013 <-make_data_file_download(raw_dir, sub_dir2013, file1_url_2013,file1_name_2013)
```
**CLEANUP**

Now we load the file
```{r}
  data1_xlsx_2013 <- read.xlsx(file1_rel_path_2013,sheetIndex = 1,startRow = 3)[,1:4]
```
The structure is
```{r}
  str(data1_xlsx_2013)
```
The levels for the Reference and Name seem OK because they are all unique as expected. Let us check the levels for Status and Final.Grade:
```{r}
  levels(data1_xlsx_2013$Status)
  levels(data1_xlsx_2013$Final.Grade)
```
We see that there is a 7* level which means that it is recommended for funding under under that stipulated in Art. 8º of Dec-Law 29/2001, 3rd February. For the purpose of analysing the evaluation scores we can convert it to a normal value of 7. Thus we first convert this factor to numeric (since it is a score) and then convert all factor to numeric in this column.
```{r}
  levels(data1_xlsx_2013$Final.Grade)[6] <- 7
  data1_xlsx_2013$Final.Grade <- as.numeric(as.character(data1_xlsx_2013$Final.Grade))
```
Let us histogram to make sure everything is OK
```{r}
  hist(data1_xlsx_2013$Final.Grade,breaks = seq(2.5,9.5,by = 1))
```

Now, for an easier notatation let us rename columns and levels according to the following logic. For this year I will use Status1 Status2 and Status3 to indicate the status in each of the files and the corresponding levels will be Yes or No. Similarly the Grade columns will be Grade1, Grade2 and Grade3, and for a more compact notation "Reference" will be "Ref":
```{r}
  colnames(data1_xlsx_2013)[1]<- "Ref"
  colnames(data1_xlsx_2013)[3]<- "Status1"
  colnames(data1_xlsx_2013)[4]<- "Grade1"
  colnames(data1_xlsx_2013)
  levels(data1_xlsx_2013$Status1)[1] <- "Yes"
  levels(data1_xlsx_2013$Status1)[2] <- "No"
  levels(data1_xlsx_2013$Status1)
```
As a consistency check let us see if the the candidates are ordered correctly
```{r}
  unique(data1_xlsx_2013$Grade1-sort(data1_xlsx_2013$Grade1,decreasing=TRUE))
```


### Ranked list after appeals
** DOWNLOAD **
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file2_url_2013 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2013/docs/IF2013-ListaOrdenadaAposAP-RankedListAfterAppeals-Locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file2_name_2013 <- "2013-file2-all_candidates_after_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  file2_rel_path_2013<-make_data_file_download(raw_dir, sub_dir2013, file2_url_2013,file2_name_2013)
```

**CLEANUP**

Now we load the file
```{r}
  data2_xlsx_2013 <- read.xlsx(file2_rel_path_2013,sheetIndex = 1,startRow = 3)[,1:4]
```
The structure is
```{r}
  str(data2_xlsx_2013)
```
The levels for the Reference and Name seem OK because they are all unique as expected. Let us check the levels for what we will call Grade2 and Status2:
```{r}
  unique(data2_xlsx_2013$Classificação...Score)
  levels(data2_xlsx_2013$Financiamento...Funding)
```
The score are all good and numeric so we can just rename the column. The Grade has two more cases in practice (because the gender is not specified for all cases anyway). Let us first rename the columns:
```{r}
  colnames(data2_xlsx_2013)[1]<- "Ref"
  colnames(data2_xlsx_2013)[2]<- "Name"
  colnames(data2_xlsx_2013)[3]<- "Grade2"
  colnames(data2_xlsx_2013)[4]<- "Status2"
  colnames(data2_xlsx_2013)
```
Now let us simplify the Status2 information
```{r}
  levels(data2_xlsx_2013$Status2)[1] <- "Quit"
  levels(data2_xlsx_2013$Status2)[2] <- "Excluded"
  levels(data2_xlsx_2013$Status2)[4] <- "No"
  levels(data2_xlsx_2013$Status2)[5] <- "Yes"
  levels(data2_xlsx_2013$Status2)[3] <- "Excluded"
  levels(data2_xlsx_2013$Status2)
```
Let us histogram to make sure everything is OK
```{r}
  hist(data2_xlsx_2013$Grade2,breaks = seq(2.5,9.5,by = 1))
```

As a consistency check let us see if the the candidates are ordered correctly
```{r}
  unique(data2_xlsx_2013$Grade2-sort(data2_xlsx_2013$Grade2,decreasing=TRUE))
```
The discrepancy is due to the "Excluded" or "Quit" cases. Let us eliminate that from the verification
```{r}
  valid_2013_file2 <- as.logical((data2_xlsx_2013$Status2!="Excluded")*(data2_xlsx_2013$Status2!="Quit"))
  unique(data2_xlsx_2013[valid_2013_file2,"Grade2"]-sort(data2_xlsx_2013[valid_2013_file2,"Grade2"],decreasing=TRUE))
```

### Ranked list final

**DOWNLOAD**

We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file3_url_2013 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2013/docs/IF2013-ListaOrdenadaFinal-RankedListFinal-Locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file3_name_2013 <- "2013-file3-all_candidates_final.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  file3_rel_path_2013 <- make_data_file_download(raw_dir, sub_dir2013, file3_url_2013,file3_name_2013)
```

**CLEANUP**

Now we load the file
```{r}
  data3_xlsx_2013 <- read.xlsx(file3_rel_path_2013,sheetIndex = 1,startRow = 3)[,1:4]
```
The structure is
```{r}
  str(data3_xlsx_2013)
```
The levels for the Reference and Name seem OK because they are all unique as expected. Let us check the levels for what we will call Grade3 and Status3:
```{r}
  unique(data3_xlsx_2013$Classificação...Score)
  levels(data3_xlsx_2013$Decisão.de.Financiamento...Funding.decision)
```
The score are all good and numeric so we can just rename the column. The Grade has two more cases in practice (because the gender is not specified for all cases anyway). Let us first rename the columns:
```{r}
  colnames(data3_xlsx_2013)[1]<- "Ref"
  colnames(data3_xlsx_2013)[2]<- "Name"
  colnames(data3_xlsx_2013)[3]<- "Grade3"
  colnames(data3_xlsx_2013)[4]<- "Status3"
  colnames(data3_xlsx_2013)
```
Now let us simplify the Status3 information
```{r}
  levels(data3_xlsx_2013$Status3)[1] <- "Quit"
  levels(data3_xlsx_2013$Status3)[2] <- "Excluded"
  levels(data3_xlsx_2013$Status3)[4] <- "No"
  levels(data3_xlsx_2013$Status3)[5] <- "Yes"
  levels(data3_xlsx_2013$Status3)[3] <- "Excluded"
  levels(data3_xlsx_2013$Status3)
```
Let us histogram to make sure everything is OK
```{r}
  hist(data3_xlsx_2013$Grade3,breaks = seq(2.5,9.5,by = 1))
```

As a consistency check let us see if the the candidates are ordered correctly
```{r}
  unique(data3_xlsx_2013$Grade3-sort(data3_xlsx_2013$Grade3,decreasing=TRUE))
```
The discrepancy is due to the "Excluded" or "Quit" cases. Let us eliminate that from the verification
```{r}
  valid_2013_file3 <- as.logical((data3_xlsx_2013$Status3!="Excluded")*(data3_xlsx_2013$Status3!="Quit"))
  unique(data3_xlsx_2013[valid_2013_file3,"Grade3"]-sort(data3_xlsx_2013[valid_2013_file3,"Grade3"],decreasing=TRUE))
```

### Changes from  file1 to file2 and  file3 and final dataset

At this point we suspect that file 2 and file 3 are basically the same. Let us check 
```{r}
  sum(data2_xlsx_2013[order(data2_xlsx_2013$Ref),"Ref"] ==data3_xlsx_2013[order(data3_xlsx_2013$Ref),"Ref"])
  sum(data2_xlsx_2013[order(data2_xlsx_2013$Ref),"Grade2"] ==data3_xlsx_2013[order(data3_xlsx_2013$Ref),"Grade3"])
  sum(data2_xlsx_2013[order(data2_xlsx_2013$Ref),"Status2"] ==data3_xlsx_2013[order(data3_xlsx_2013$Ref),"Status3"])
```
So we see that there was only one change in grade. Let us see which record this is
```{r}
  record_changef2f3_2013 <- !(data2_xlsx_2013[order(data2_xlsx_2013$Ref),"Grade2"] ==data3_xlsx_2013[order(data3_xlsx_2013$Ref),"Grade3"])
  data2_xlsx_2013[order(data2_xlsx_2013$Ref),][record_changef2f3_2013,]
  data3_xlsx_2013[order(data3_xlsx_2013$Ref),][record_changef2f3_2013,]
```
Thus, we can safely just use file1 and file3. First we check that all candidates are in both so that we can compare directly
```{r}
  dim(data1_xlsx_2013)
  dim(data3_xlsx_2013)
```
So there is one record missing in data1. We need to find which one
```{r}
  missing_in_file1_2013 <- setdiff(data3_xlsx_2013$Ref,data1_xlsx_2013$Ref)
  data3_xlsx_2013[data3_xlsx_2013$Ref==missing_in_file1_2013,]
```

Now we can check the amount of differences if we eliminate this record.

```{r}
  data3_temp_2013 <-data3_xlsx_2013[-1461,]
  data3_temp_2013$Ref<-factor(data3_temp_2013$Ref)
  dim(data3_temp_2013)
  sum(data1_xlsx_2013[order(data1_xlsx_2013$Ref),"Ref"] ==data3_temp_2013[order(data3_temp_2013$Ref),"Ref"])
  sum(data1_xlsx_2013[order(data1_xlsx_2013$Ref),"Grade1"] ==data3_temp_2013[order(data3_temp_2013$Ref),"Grade3"])
```
So we can see that changes in grade were minor. In any case let us see these cases.
```{r}
  grade_changef1f3_2013 <- !(data1_xlsx_2013[order(data1_xlsx_2013$Ref),"Grade1"] ==data3_temp_2013[order(data3_temp_2013$Ref),"Grade3"])
  side_by_side_2013_changes <-data1_xlsx_2013[order(data1_xlsx_2013$Ref),][grade_changef1f3_2013,c("Ref","Name","Grade1")]
  side_by_side_2013_changes$Grade3 <-data3_temp_2013[order(data3_temp_2013$Ref),][grade_changef1f3_2013,"Grade3"]
  side_by_side_2013_changes$Status1 <-data1_xlsx_2013[order(data1_xlsx_2013$Ref),][grade_changef1f3_2013,"Status1"]
  side_by_side_2013_changes$Status3 <-data3_temp_2013[order(data3_temp_2013$Ref),][grade_changef1f3_2013,"Status3"]
  side_by_side_2013_changes
```

So there are only a few cases of changes in the mark of the candidate after the appeal. We can histogram the differences
```{r}
  hist(side_by_side_2013_changes$Grade3-side_by_side_2013_changes$Grade1,breaks = seq(-1.5,2.5,by = 1))
  side_by_side_2013_changes$Grade3-side_by_side_2013_changes$Grade1
```

Finally we want to export a single file with all the information. We make a data frame ordered by Ref with the candidate that was missing excluded
```{r}
  data_2013 <- data1_xlsx_2013[order(data1_xlsx_2013$Ref),c("Ref","Name","Grade1")]
  data_2013$Grade3<-data3_temp_2013[order(data3_temp_2013$Ref),][,"Grade3"]
  data_2013$Status1 <- data1_xlsx_2013[order(data1_xlsx_2013$Ref),"Status1"]
  data_2013$Status3<-data3_temp_2013[order(data3_temp_2013$Ref),][,"Status3"]
  head(data_2013)
```
Now export TO DO!!!! MAKE GENERIC FUNCTIONS
.........

Q: The mistakes seem to always disfavour candidates?



## IF competition 2014

In this year and following the competition became a two stage process. The sub-directory name for the data for this year was chosen to be named
```{r, warning=FALSE}
  sub_dir2014 <- "2014"
```

### Stage 1
#### Before appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file1_stage1_url_2014 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2014/docs/IF2014_1stStageResultsAfterEvaluation-locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file1_stage1_name_2014 <- "2014-file1-stage1-all_candidates_before_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2014, file1_stage1_url_2014,file1_stage1_name_2014)
```
#### After appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file2_stage1_url_2014 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2014/docs/IF2014_1stStageFinalResults-locked.xls"
```
and chose the filename
```{r, warning=FALSE}
  file2_stage1_name_2014 <- "2014-file2-stage1-all_candidates_after_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2014, file2_stage1_url_2014,file2_stage1_name_2014)
```

#### After complaint
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file3_stage1_url_2014 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2014/docs/IF2014_1stStageFinalList-locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file3_stage1_name_2014 <- "2014-file2-stage1-all_candidates_after_complaint.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2014, file3_stage1_url_2014,file3_stage1_name_2014)
```


### Stage 2 
#### Before appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file1_stage2_url_2014 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2014/docs/IF2014_2ndStageResults-locked.xls"
```
and chose the filename
```{r, warning=FALSE}
  file1_stage2_name_2014 <- "2014-file1-stage2-all_candidates_before_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2014, file1_stage2_url_2014,file1_stage2_name_2014)
```

#### After appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file2_stage2_url_2014 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2014/docs/IF2014_2ndStageResults_AfterAppeals_Locked-230615.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file2_stage2_name_2014 <- "2014-file2-stage2-all_candidates_after_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2014, file2_stage2_url_2014,file2_stage2_name_2014)
```

#### Final results
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file3_stage2_url_2014 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2014/docs/IF2014_2ndStageFinalResults-locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file3_stage2_name_2014 <- "2014-file3-stage2-all_candidates_final.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2014, file3_stage2_url_2014,file3_stage2_name_2014)
```


## IF competition 2015

In this year and following the competition became a two stage process. The sub-directory name for the data for this year was chosen to be named
```{r, warning=FALSE}
  sub_dir2015 <- "2015"
```

### Stage 1
#### Before appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file1_stage1_url_2015 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2015/docs/IF2015_Fase1_AposAvaliacao-Locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file1_stage1_name_2015 <- "2015-file1-stage1-all_candidates_before_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2015, file1_stage1_url_2015,file1_stage1_name_2015)
```
#### After appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file2_stage1_url_2015 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2015/docs/IF2015_Fase1_AposAudienciaPrevia_locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file2_stage1_name_2015 <- "2015-file2-stage1-all_candidates_after_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2015, file2_stage1_url_2015,file2_stage1_name_2015)
```

### Stage 2
#### Before appeal
We downloaded the raw data from the direct link  at
```{r, warning=FALSE}
  file1_stage2_url_2015 <- "https://www.fct.pt/apoios/contratacaodoutorados/investigador-fct/2015/docs/IF2015_Fase2_AposAvaliacao_locked.xlsx"
```
and chose the filename
```{r, warning=FALSE}
  file1_stage2_name_2015 <- "2015-file1-stage2-all_candidates_before_appeal.xlsx"
```
To download  we call:
```{r, warning=FALSE}
  make_data_file_download(raw_dir, sub_dir2015, file1_stage2_url_2015,file1_stage2_name_2015)
```

## Extra data
 TO DO!!!




